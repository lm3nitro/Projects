
# Introduction

![image](https://github.com/user-attachments/assets/97cb2393-6307-4803-a85a-d04f21a41afd)

The Security team believes that a web server was compromised by an attacker and that the attacker might have exploited a Local File Inclusion (LFI) vulnerability. The LFI vulnerabiility refers to a security flaw that allows an attacker to access files on a web server. This is partially due to the several alerts that were triggered regarding data loss prevention, suggesting that the adversary might have exfiltrated sensitive files and information from the server 

As an analyst my responsibility is to analyze the provided PCAP file, leverage the insights gained to update the Snort (IDS/IPS) rules, and assess whether the web server has been compromised

## PCAP Analysis

First, I will be using Wireshark to analyze the PCAP file and see if there are any unique User-Agent strings. One of the first things I noticed was the following User-Agent:

```"http.user_agent == "Mozilla/4.0 (Hydra)"```

![Pasted image 20250110145417](https://github.com/user-attachments/assets/33e69cfa-c35d-4bff-8114-3910d61c73be)

I also see that it references a HTTP GET request from the following URL:

hxxp[:]//192.168.1.6/login[.]php

![Pasted image 20250110145511](https://github.com/user-attachments/assets/49ed7cb4-fba0-4221-b047-efa9741844b7)

Upon further investigation, I see that the web server responds with an HTTP 401 status code which references failed login attempts. Based on the User-Agent, it appears that this is being done using Hydra.

Below is the information gathered from the traffic related to the HTTP 401 status code:

```http.response.code == 401```

![Pasted image 20250110150042](https://github.com/user-attachments/assets/c3bab830-f799-4b32-86cb-21483957c8df)

The screenshot above is showing 1742 packets related to the status code. Looking into one of the packets, I see the following:

![Pasted image 20250110145841](https://github.com/user-attachments/assets/e96a74ba-ca07-46d9-8d27-6b6f771074aa)

> [!NOTE]  
> A common Local File Inclusion (LFI) payload involves embedding the `../` string within URL parameters to exploit directory traversal vulnerabilities, potentially allowing access to sensitive files or directories outside the web root.

Having this information on LFI, I took a closer look at the traffic to see if there was any traffic related to the above:

```http contains "../"```

![Pasted image 20250110165123](https://github.com/user-attachments/assets/7a5ead2b-b018-4659-afef-442b774236a7)

Utilizing this filter, there were 5 packets that contained this information. Using CyberChef, I converted the "../" to HEX:

![Pasted image 20250110165657](https://github.com/user-attachments/assets/b1f5f2fd-ddac-4103-89e9-019a449a5ea6)

This HEX will allow me to create a Snort rule to detect on this traffic related to the string.

Going back to Wireshark, upon further analysis, I was able to see the following:

![Pasted image 20250110172154](https://github.com/user-attachments/assets/37a8f0e1-2595-4ff5-a93e-7ff8695ea507)

It appears that by exploiting the Local File Inclusion (LFI) vulnerability on the admin panel, the attacker the was able to steal a private SSH key from the web server. I then searched for the known file signature of an OpenSSH private key file and found the following information:

```https://en.wikipedia.org/wiki/List_of_file_signatures```

![Pasted image 20250110173606](https://github.com/user-attachments/assets/fb706c43-b78d-4666-b5d0-8f4eb4f93c90)

![Pasted image 20250110173538](https://github.com/user-attachments/assets/36348344-fb2f-4bfc-a28b-bb410224d337)

This is another IOC that I will be using to create a custom rule to detect and alert on private keys traversing the network.

## Custom Snort Rules

Now that I have analyzed the PCAP using Wireshark, I wanted to create a few Snort rules to alert on these IOCs gathered from my analysis above:

#### 1. Failed Login Rule:
 
 This first rule is to alert on failed login attempts (HTTP 401 response codes) when they occur within a 30-second period from the same source IP address. 

```alert tcp any 80 -> any any ( msg:"HTTP/1.0 401 Unauthorized from SERVER"; content:"HTTP"; content:"401"; http_stat_code; flow:from_server; threshold:type threshold, track by_src, count 10 , seconds 30; sid:1000000111; rev:1; ) ```

Testing:

![Pasted image 20250110163322](https://github.com/user-attachments/assets/610f1de8-65e3-416f-ba4e-d8a4f7cc0860)

#### 2. Successful Login Rule:

Using the same process as above, I also wanted to create an alert for successful login attempts. When researching, successful login attempts have a HTTP 302 redirect to the admin portal.

```alert tcp any 80 -> any any ( msg:"Successful login to web1.prod.xyz.com from untrust http_stats_code:302"; content:"302"; http_stat_code; flow:from_server,established; priority:1; sid:10000005; rev:1; )```

Testing against Successful login attempt rule:

![Pasted image 20250110164615](https://github.com/user-attachments/assets/97be3342-bf73-49b9-8261-658052072164)

I see that there were 2 alerts generated based on the successful login rule created previously.  Based on the alerts generated, I decided to decode the HTTP headers using tcpdump:

![Pasted image 20250110164716](https://github.com/user-attachments/assets/1350de42-245b-4a0f-9682-4106abc95dbf)

Here I was able to see the HTTP 302 status code which infers that the login attempts was successful.

#### 3. LFI `../` String rule"

This next rule was to test on the ../ string rule that was seen in the traffic above: 

```alert tcp any any -> any 80 ( msg:"LFI attempt -Path Traversal"; content:"GET"; http_method; flow:to_server; content:"|2e 2e 2f|"; http_uri; priority:1; sid:10000005; rev:1; ) ```

Testing: 

After creating the rule, I then test against it to test its functionality using the same PCAP. Here I see that there were 5 alerts triggered which is correct, considering there were 5 packets referenced in Wireshark above:

![Pasted image 20250110171254](https://github.com/user-attachments/assets/6a5a7a53-7795-4a4f-90b4-ffd8592fd2b4)

#### 4. Private Key Rule:

Based on my analysis of the PCAP, I was also able to see that the attacker was able to steal the Private Key SSH key from the server. This rule will detect and alert on private keys traversing the network:

```alert tcp any 80 -> any any (msg: "Signature of an OpenSSH private key file download from Web Server"; flow:from_server; file_data; content:"|2D 2D 2D 2D 2D 42 45 47 49 4E 20 4F 50 45 4E 53 53 48 20 50 52 49 56 41 54 45 20 4B 45 59 2D 2D 2D 2D 2D|"; priority:1; sid:100000066; rev:1;)```

Testing:

![Pasted image 20250110175508](https://github.com/user-attachments/assets/cd54e4cc-a4c0-4640-8038-9680dcff1d7e)

The output from the test shows that it is detecting on the rule created. Next, I then used tcpdump to analyze the alert generated above:

```sudo tcpdump -nr snort.log.1736549962 -A```

![Pasted image 20250110180215](https://github.com/user-attachments/assets/7fb1bbdb-23e9-445f-a3db-83f4ca90d3fe)

I see that there is an HTTP 200 OK. 

### Exporting the payload with Tshark:

Next, I decided to export the object found using Tshark:

```
sudo tshark -nr snort.log.1736549962 --export-object http,.
```

> [!NOTE]  
>The  period "." at the end means current directory 

![Pasted image 20250110180942](https://github.com/user-attachments/assets/54881210-5da6-4af8-9f60-bc850d30d828)

After obtaining the private key, the attacker gained access to the web server using SSH and started exfiltrating sensitive data using FTP. I used the command below to see the FTP related commands:

```sudo tshark -nr snort.log.1736551726 -Y "ftp.request.command"```

![Pasted image 20250110184816](https://github.com/user-attachments/assets/93a5a25a-ff7d-4bbc-9325-6918f2990179)

Using the information found on FTP, I also created a rule to detect and alert on any outgoing connections to an external FTP server outside of the 192.168.1.0/24 network range:

```alert tcp 192.168.1.0/24  any -> !192.168.1.0/24 21 ( msg:Outgoing connections to an external FTP server outside HOME_NET priority:1; sid:10000005; rev:1;)```

Testing rule:

```sudo snort  -c /etc/snort/snort.conf -r Oinksoft_LFI.pcap -A console -q -k none```

![Pasted image 20250110182802](https://github.com/user-attachments/assets/93050c06-91c1-4616-be28-9f6103d2a94b)

I see that the IP address of the FTP server is '194.108.117.16'. Doing some research on the IP, it is registered in Czech Republic:

![Pasted image 20250110183057](https://github.com/user-attachments/assets/6a64602a-2079-4e2e-b3d3-ee7905bdefcf)

## Defense Actions

In conclusion, the web server was indeed compromised and did exfiltrate information to an outside and unknown FTP server. Using the IOCs gathered upon analyzing the PCAP, the Snort rules were updated to include this information. 

The web server had to be isolated from the network and reimaged and patched to minimize the attack surface. Outside of that, services such as FTP that were not being used were blocked from communicating outside of the network. 
