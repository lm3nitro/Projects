# Introduction

As a an analyst, I have been provided with a PCAP file that was flagged due to an abnormal amount of HTTP traffic observed on the network. This unusual pattern was detected by the IDS, and it has raised concerns that a compromised host may be engaged in suspicious or malicious activities.

## Report Inforamtion

To get all the statistics from the provided pcap file, I used capinfos:

```
capinfos 2024-04-18.pcap
```

![Pasted image 20250105092610](https://github.com/user-attachments/assets/aa0c49a1-d3c1-4531-acad-f45f97c82e29)

+ **Date of Analysis:** 04-18-2024
+ **PCAP File Name:** 2024-04-18.pcap
+ **PCAP File Size:** 6708 KB
+ **PCAP Duration:** 5059.871146 seconds
+ **Source of PCAP:** Intrusion Detection System (IDS)

Next, I confirmed the number of packets:

```
tcpdump -r 2024-04-18.pcap --count
```

![Pasted image 20250105092513](https://github.com/user-attachments/assets/59636fe9-ec16-4a4b-9bae-e37fdb8b4b16)

## Filtering PCAP:

I then wanted to see the list of all the source IPs to see the top talkers:

```
tcpdump -tt -nr 2024-04-18.pcap tcp | cut -d " " -f 3 | cut -d "." -f 1-4 | sort | uniq -c | sort -nr
```

![Pasted image 20250105093452](https://github.com/user-attachments/assets/789f99ca-ea34-4aa3-a730-605ba8c9b48b)

Based on the output, I see that the 10.4.18.169 (internal) and the 85.239.53.219 (external) are the ones that have communicated the most.

I then checked the top destination IP addresses:

```
tcpdump -tt -nr 2024-04-18.pcap tcp | cut -d " " -f 5 | cut -d "." -f 1-4 | sort | uniq -c | sort -nr
```

![Pasted image 20250105093320](https://github.com/user-attachments/assets/633a91d3-aa00-4a0c-9297-036c35edf0f7)

I see again that the 85.239.53.219 is one of the top destination IPs as well. I then searched for both the internal IP and the 85.239.53.219:

```
tcpdump -tt -nr 2024-04-18.pcap 'tcp and src 10.4.18.169 and dst 85.239.53.219' --count
```

![Pasted image 20250105093657](https://github.com/user-attachments/assets/cbf9e1c3-df92-4692-90b9-bcfdacfed48f)

I can see that there were 1169 packets passed between these 2 IPs. I then wanted to check the source ports between these two IPs:

```
tcpdump -tt -nr 2024-04-18.pcap tcp and src 10.4.18.169 and dst 85.239.53.219 | cut -d " " -f 3 | cut -d "." -f 5 | sort | uniq -c | sort -nr
```

![Pasted image 20250105094257](https://github.com/user-attachments/assets/811f44ad-41d6-4e6d-829c-fba39dff322e)

Next, I checked the destination ports between these two IPs:
```
tcpdump -tt -nr 2024-04-18.pcap tcp and dst 10.4.18.169 and src 85.239.53.219 | cut -d " " -f 3 | cut -d "." -f 5 | sort | uniq -c | sort -nr
```

![Pasted image 20250105094347](https://github.com/user-attachments/assets/0098db0a-ddbc-4b11-a4f2-8dba1ba51fea)

Based on the output, I can see that all the communication is being done over port 80. Knowing that Http protocol runs on port 80, I then filtered to check the amount of  GET or POST requests:

```
tcpdump -tt -nr 2024-04-18.pcap tcp and src 10.4.18.169 and dst 85.239.53.219 | grep -E "GET|POST" --count
```

![Pasted image 20250105095240](https://github.com/user-attachments/assets/e1706972-73a3-4f36-83ad-b0f33f977ec5)

This allowed me to see the large amount (294) packets that were either POST or GET requests.

I then searched for the HTTP header information related to GET or POST:
```
tcpdump -tt -nr 2024-04-18.pcap tcp and src 10.4.18.169 and dst 85.239.53.219 | grep -E "GET|POST"
```

![Pasted image 20250105095416](https://github.com/user-attachments/assets/ae07078a-983a-4181-bb2d-95e517574f37)

## Decoding

With the provided output above, I wanted to decode the first 5 packets seen in the output:

```
tcpdump -tt -nr 2024-04-18.pcap tcp and src 10.4.18.169 and dst 85.239.53.219 -c 5 -A
```

![Pasted image 20250105095726](https://github.com/user-attachments/assets/b3184d9e-3ede-4ff2-8e89-9013a1c0c3f7)


Upon searching, I found a very strange user agent called: SSLoad/1.1. This caught my attention, and I wanted to investigate further.

## User Agent Analysis

Using google, I searched for the User Agent SSLoad/1.1, and found the following:

```https://malpedia.caad.fkie.fraunhofer.de/details/win.ssload```

![Pasted image 20250105100618](https://github.com/user-attachments/assets/360cb972-8f05-4065-9906-812c083e775c)

Based on the output, it shows that this is a Rust-based downloader user toi deliver secondary payloads. To further research, I also used any.run. The following was found:

```https://any.run/malware-trends/ssload/```

![Pasted image 20250105100305](https://github.com/user-attachments/assets/d8caad5b-3c55-4815-8d77-f1605fb4cb86)

As seen in the screenshot above, this is the same IP mentioned within the pcap. Since this a well-known malware, I decided to investigate a bit further to find more information about the IOCs related to this particular malware. Knowing the IOCs associated will allow me to continue my search not only within the pcap file but also in my organization to ensure that there is no other trace found.

Upon further research, I was able to find the following information provided by PaoAlto Unit42:

```https://github.com/PaloAltoNetworks/Unit42-timely-threat-intel/blob/main/2024-04-15-IOC-for-Contact-Forms-campaign-SSLoad-activity.txt```

SSLOAD DLL INSTALLED AND RUN BY THE ABOVE MSI FILE:

- SHA256 hash: 09ffc4188bf11bf059b616491fcb8a09a474901581f46ec7f2c350fbda4e1e1c
- File size: 718.848 bytes
- File location: C:\Users\[username]\AppData\Local\sharepoint\MenuEx.dll
- Run method: regsvr32.exe /s [filename]
- Sample available at: https://bazaar.abuse.ch/sample/09ffc4188bf11bf059b616491fcb8a09a474901581f46ec7f2c350fbda4e1e1c/
- Note: This malware is kept persistent by a scheduled task.

POST-INFECTION TRAFFIC:

- hxxps[:]//t[.]me/+st2YadnCIU1iNmQy
- 85.239.53[.]219 port 80 - 85.239.53[.]219 - GET /api/g   <-- encrypted payload
- port 443 - api.ipify.org - HTTPS traffic
- 85.239.53[.]219 port 80 - 85.239.53[.]219 - POST /api/gateway HTTP/1.1 , JSON (application/json)
- 85.239.53[.]219 port 80 - 85.239.53[.]219 - POST /api/b0408631-d621-61e4-7035-f7d17fc50af8/tasks HTTP/1.1
- 85.239.53[.]219 port 80 - 85.239.53[.]219 - GET /download?id=Cosmos&module=2&filename=None HTTP/1.1

## Domain Name Analysis:

With the information found, I then went back to the pcap and filtered for the domain names associated with the host 85.239.53.219 :

```
tcpdump -tt -r 2024-04-18.pcap host 85.239.53.219 | tail
```

![Pasted image 20250105102651](https://github.com/user-attachments/assets/c0f8aa46-7654-4dec-9d4a-d4c7e9a50d8c)

The domain found was all the same: hxxp[://]xfdxyf6rfy[.]firstopportunity[.]online

Based on the domain found, it appears that the attacker is random generating sub-domains. I searched for the base domain in VirusTotal:

![Pasted image 20250105103255](https://github.com/user-attachments/assets/a7da43f8-d534-4230-b230-283f5ee613ff)

Here I see that it is being flagged by a vendor as phishing. 

## Credential and User Information

Next, I filtered the PCAP to search for credentials, passwords, including user or endpoint information all associated with the IP (85.239.53.219):

```
tcpdump -tt -r 2024-04-18.pcap host 85.239.53.219 -A | grep -i "user\|pass\|loging" | grep -v "User-Agent"
```

![Pasted image 20250105103738](https://github.com/user-attachments/assets/c1b7df3b-f0da-4104-a896-91d77ebbd78b)

The following was found:

+ **Version:** "v1.3.1"
+ **IP:**"173.66.46.112"
+ **Domain**:"PARTRIDGECLIFF"
+ **Hostname:**"DESKTOP-PQB4TRZ"
+ **Arch:**"x86","os_version":"Windows 10.0.22631"
+ **Cur_User:**"User","owner":"LosAngeles"

## File Filtering

I then filtered for files downloaded:

```
tcpdump -tt -r 2024-04-18.pcap host 85.239.53.219 -A | grep "filename"

```

![Pasted image 20250105104215](https://github.com/user-attachments/assets/c875cf2c-e7ea-472b-9589-9ee8802bc4d5)

The output above shows that there was a .bin file downloaded. I then searched for the dll wihtin the PCAP:

```
tcpdump -tt -r 2024-04-18.pcap | grep dll
```

![Pasted image 20250105110837](https://github.com/user-attachments/assets/804f1ece-7488-4569-994f-e6dbdea846ac)

THis allowed me to see the GET request associated with the dll.bin file.

## Extracting Payload

Provided the information found, this warrants for further investigation to see what exactly was downloaded and the behavior. To do this, I used a custom python script to extract the Payload:

```
python3 pe_extract.py -i 2024-04-18.pcap
```

This can also be done via Wireshark:

![Pasted image 20250105105715](https://github.com/user-attachments/assets/0f9c5fcc-11a7-4037-86c2-64cf3cfdb8b6)

I then gathered the SHA256 hash for the file:

![Pasted image 20250105105828](https://github.com/user-attachments/assets/93d6443e-d2f0-44e4-9f8d-a3e982716e5e)

sha256: 0ee5e4230e5ab0aa250242aa1a8d2877f1cfccf7d12819867259f07a9c3b2804

## Dynamic File Analysis:

Once the file was extracted, I then used Hybrid Analysis to see the behavior:

```https://www.hybrid-analysis.com/sample/0ee5e4230e5ab0aa250242aa1a8d2877f1cfccf7d12819867259f07a9c3b2804```

![Pasted image 20250105105435](https://github.com/user-attachments/assets/cef5cb37-bf70-41d5-b117-4e6958be0e40)

As seen from the analysis, the SHA256 matches what I had previously generated above. This is also showing as malicious with a threat score of 10/10. For further confirmation, I also searched for the hash using VirusTotal:

https://www.virustotal.com/gui/file/0ee5e4230e5ab0aa250242aa1a8d2877f1cfccf7d12819867259f07a9c3b2804

![Pasted image 20250105110113](https://github.com/user-attachments/assets/26912937-0dc4-45ac-a68b-3429047d00a6)

Both resources indicate that the provided file/hash is malicious. 

## Post Infection Analysis

Provided all the information that was gathered, I was able to see the the host had downloaded the malicious file. Going back to the reasearch done and the information provided by Unit42 under "POST-INFECTION TRAFFIC" one of the IOCs mentions the following URL: hxxps[:]//t[.]me/+st2YadnCIU1iNmQy

I then searched for this IOC in the pcap:

![Pasted image 20250105110405](https://github.com/user-attachments/assets/01fb73f2-48f4-443d-b162-29b0b7f77ee2)

Filtering traffic base on the domain t.me:

```
tcpdump -tt -r 2024-04-18.pcap host t.me

```

![Pasted image 20250105110527](https://github.com/user-attachments/assets/d20f1ccc-971f-4b06-9eeb-1f796fce9725)

Based on my findings and the information acquired, the internal host (IP 10.4.18.169) was found compromised and infected with this malicious file. It was also found that it was communicating with the C2 control server post infection.

## Defensive Actions
+ Host was isolated and contained
+ Firewall rules were updated to block any communication with the associated IPs/URLs
+ Malware was removed from host and system was reimaged
+ Checked network and EDR to ensure that no other hosts on the network were compromised
+ IDS/IPS rules were updated
