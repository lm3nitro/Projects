# Introduction:

A PCAP was triggered after an unusually high volume of traffic was detected between two internal hosts, raising concerns of a potential compromised host. Initial analysis reveals abnormal protocols being used, suggesting that one of the hosts may have been compromised and is communicating with the other for lateral movement.

## PCAP Analysis

#### File properties:

Before getting started with the traffic contained in the PCAP, I took a look at the file file properties in Wireshark:

![Pasted image 20250107050859](https://github.com/user-attachments/assets/6f58fadc-b39a-4a76-aee6-ccaa0770316e)

![Pasted image 20250107051829](https://github.com/user-attachments/assets/4360af5d-9fef-46aa-ac0c-9ad33c5054cb)

+ **Date of Analysis:** 02-03-2023
+ **PCAP File Name:** 2023-02-03.pcap
+ **PCAP File Size:** 32 MB
+ **PCAP Duration:** 10326.359 seconds (2:52:06 hours)
+ **Number of Packets:** 55207

#### Conversations:

I then took a closer look at the conversations captured in the traffic to see who were the top talkers and which IPs were communciating with eachother:

![Pasted image 20250107051315](https://github.com/user-attachments/assets/f872bd29-4ec6-4d26-b5fe-c6b830977f04)

> [!NOTE]
>  The 10.0.0.149 is communicating the most with 10.0.0.6 which is an internal IP on the same subnet

#### Protocol Hierarchy:

I also reviewed the protocol heirarchy to see which were the most used protocols or anything that stands out:

![Pasted image 20250107052236](https://github.com/user-attachments/assets/1a109da9-916e-4538-b7b6-65cdec217e67)

From the information gathered, the host on IP "10.0.0.149" has some Kerberos and Active Directory related traffic as well as some unencrypted HTTP traffic. I will be analyzing the HTTP traffic first since I am able to see the header information. 

#### HTTP Requests:

To get started with the HTTP traffic, I looked under the HTTP Request Tab. Here I can see that it mentions a .dat file:

![Pasted image 20250107060518](https://github.com/user-attachments/assets/21346ff3-8ff9-4591-95cc-7901c369f3a6)

#### Filtering for HTTP traffic:

This .dat file caught my attention. I then went to look at the http traffic to see the traffic related to and sorrounding this .dat file:

![Pasted image 20250107075148](https://github.com/user-attachments/assets/55b08118-7566-45a0-8e11-ac1a7dd86037)

It appears that the host (10.0.0.149) is communicating with a server that doesn't have a domain name, instead it references an IP address. This looks suspicious anbd warrants further analysis. I then took a look at the GET requests. This is where I was able to see that the host appears to be downloading a file with a ".dat" extension. 

URL: hxxp[://]128[.]254[.]207[.]55/86607[.]dat

#### Following the HTTP Stream:

![Pasted image 20250107055617](https://github.com/user-attachments/assets/3087ad27-d787-47b5-991e-2418abf7d77a)

When analyzing the "User-Agent" it suggests that the user downloaded an executable using the CURL utility.

> [!NOTE]  
> Its important to note that the average user will not be using the CURL utility to proactively download a ".dat" file.

Another important piece of information gathered is the mention of the highlighted line above mentioning "MZ...DOS mode". I researched this information:

```https://en.wikipedia.org/wiki/List_of_file_signatures```

![Pasted image 20250107060050](https://github.com/user-attachments/assets/db1a344e-c5ff-41e3-afc3-bdf57ea402a6)

## IP and URL Analysis

#### IP Analysis: 

Next, I investigated the IP referenced as the "Host" in the HTTP stream (128.254.207.55):

```https://www.abuseipdb.com/check/128.254.207.55```

![Pasted image 20250107093302](https://github.com/user-attachments/assets/b3a9b60e-fc26-418c-bb1b-0959a8fadd2e)

Based on the results, it looks like this IP was previously reported and is associated with being involved with malware. 

#### URL Analysis:

I also used VirusTotal to take a look at the URL:

```https://www.virustotal.com/gui/url/ddda8eadcb391f8cab4d72811335c265a399d538ff45fe5e04feabbff968ed11```

![Pasted image 20250107055110](https://github.com/user-attachments/assets/369886ed-0f60-4904-a90d-04cc381af2a7)

This URL was been flagged by more than 6 vendors as malicious. 

## File Analysis:

Considering the information gathered thus far, I wanted to further explore the file that was downloaded. To do this, I exported it using Wireshark:

![Pasted image 20250107061004](https://github.com/user-attachments/assets/3901e76c-98bd-4797-bf1c-76d45eeaf65c)

I then used the ‘file’ command in Linux to determine the type of a file:

![Pasted image 20250107061313](https://github.com/user-attachments/assets/0b180cba-85ad-443a-a4b1-043a29a4af12)

I then generated the hash for the file:

![Pasted image 20250107061132](https://github.com/user-attachments/assets/478f29a1-f53b-4ef8-b8b9-8f88b3125025)

sha256: 713207d9d9875ec88d2f3a53377bf8c2d620147a4199eb183c13a7e957056432

#### File Reputation:

To search for the hash and file reputation I used MalwareBazaar:

```https://bazaar.abuse.ch/sample/713207d9d9875ec88d2f3a53377bf8c2d620147a4199eb183c13a7e957056432/```

![Pasted image 20250107061716](https://github.com/user-attachments/assets/1cd7d2c2-9146-4094-be1d-33628465b96a)

It appears that this hash  belongs has a signature related to the "Qakbot" 

![Pasted image 20250107062042](https://github.com/user-attachments/assets/844db178-968d-4ede-8670-aa6cb30b050a)

#### Qakbot Malware Research:

Per my research, I was able to find the following:

"Qakbot, aka Qbot and Pinkslipbot, started as a banking trojan in 2008, used to steal banking credentials, website cookies, and credit cards to conduct financial fraud. However, over time, the malware evolved into a malware delivery service utilized by other threat actors to gain initial access to networks for conducting ransomware attacks, data theft, and other malicious cyber activities. Qakbot is distributed through phishing campaigns that utilize a variety of lures, including reply-chain email attacks, which is when threat actors use a stolen email thread and then reply to it with their own message and an attached malicious document."

```https://news.sophos.com/en-us/2022/03/10/qakbot-decoded/```

![Pasted image 20250107062744](https://github.com/user-attachments/assets/94c54fe9-d35c-4869-8dff-c895ca591552)

> [!WARNING]  
> Another behavior that has been noted above is the ARP scanning that is performed for network discovery and lateral movement purposes.

```https://www.cyber.gc.ca/en/alerts-advisories/ongoing-reports-qakbot-malware-incidents```

I also saw that this type of ARP scanning is linked to a Mitre technique:

![Pasted image 20250107062619](https://github.com/user-attachments/assets/ec69c2a3-3f08-4995-a495-aa0c8b35125c)

Next, I took a closer look into the technique mentioned:

```https://attack.mitre.org/software/S0650/```

![Pasted image 20250107063151](https://github.com/user-attachments/assets/69958c9d-0002-4fe7-bb35-bb7b53d83151)

## Detecting Reconnaissance:

#### ARP:
Drawing from the information above, the malware uses ARP to scan for active hosts on the compromised network. It also uses SMB for lateral. I went back to the PCAP file to see if there were any signs of ARP scanning. 

To start, I filtered for the ARP protocol:

![Pasted image 20250107070336](https://github.com/user-attachments/assets/5a65bc1d-a4a9-4ebf-b778-eb106ba75610)

I can see that the host 10.0.0.149 is trying to find active hosts on the network.

#### ICMP:
I also looked into the ICMP traffic:

![Pasted image 20250107075232](https://github.com/user-attachments/assets/a10da743-53b3-40e8-b72c-4203e6d29ef3)

#### DNS:
Based on the output, the host 10.0.0.149 was able to get a response from 10.0.0.6. I delved into the traffic assocaited with the host 10.0.0.6. I saw that there was a lot of traffic related to DNS, so I took into it:

![Pasted image 20250107075027](https://github.com/user-attachments/assets/e02bccd3-dac9-4327-97b5-22e75b229ca2)

The host 10.0.0.149 is sending ICMP to 10.0.0.6 which is an Active Directory and DNS server based on the queries being made. I then looked for this IP in the "Resolved Addresses" section of Wireshark and was able to see the FQDN of the Domain Controller:

![Pasted image 20250107071458](https://github.com/user-attachments/assets/bfb14305-6728-4b9e-9b83-d52882e8b8cd)

#### Conversation Analysis 

I then analyzed the conversation between both the hosts 10.0.0.149 and the Domain Controller on 10.0.0.6:

```
(ip.src == 10.0.0.6 and ip.dst == 10.0.0.149) && (tcp.flags.reset == 1)
```

![Pasted image 20250107075343](https://github.com/user-attachments/assets/d294a445-5812-4057-9b1b-5dc72b2bf044)

```
(ip.src == 10.0.0.6 and ip.dst == 10.0.0.149) && (tcp.flags.syn == 1 || tcp.flags.reset == 1 )
```

![Pasted image 20250107080051](https://github.com/user-attachments/assets/75b85120-0ed4-41de-921b-30e27e10cf12)

The traffic seen in the scrrenshots above indicate that the host 10.0.0.149 is enumerating ports on the Domain Controller.

#### SMTP 

While reviewing the traffic, I also saw mention of SMTP:

![Pasted image 20250107080655](https://github.com/user-attachments/assets/1599b4c3-9e53-46f7-849a-af4eb4d95ef8)

Right away, the mention of the "AUTH LOGIN" caught my attention. I looked further into the into this:

![Pasted image 20250107080758](https://github.com/user-attachments/assets/f90e7a1f-7899-4639-91f3-fee6b1671285)

When I followed the TCP stream, I saw the following:

![Pasted image 20250107080942](https://github.com/user-attachments/assets/bb47c915-7a5f-4495-b0bc-01608e7c3bff)

I researched the code associated with the "AUTH LOGIN" 334:

![Pasted image 20250107080951](https://github.com/user-attachments/assets/576737c2-e8f0-4eef-8391-458232ee7d76)

I also looked into the code 535 also seen in the screenshot above:

![Pasted image 20250107081701](https://github.com/user-attachments/assets/5181fccf-7af6-4c58-a865-777f12a7099a)

This information suggests that the host 10.0.0.149 is trying to authenticate to the SMTP server. I was also able to find the password in base64, it seems like the authentication failed based on the return code 535.

#### Decoding Base64:

With the information found above, I used CyberChef to decode the Base64 encoded string and found the information below:

Credentials:
Username:arthit@macnels.co.thPassword:Art123456

![Pasted image 20250107081249](https://github.com/user-attachments/assets/52364ef2-f7ac-400b-8a51-b67de2907aa4)

#### SMB Analysis:

I also looked into the SMB service since there was also traffic related to the SMB protocol:

![Pasted image 20250107082720](https://github.com/user-attachments/assets/2b31b3e4-0b28-4441-9f67-2449a72e2c81)

The host 10.0.0.149 was communicating with the SMB service, it seems that there were a few transfers over the network:

![Pasted image 20250107082654](https://github.com/user-attachments/assets/05d00b10-8b0f-4401-baea-af4e2c6c6f0e)

Using Wireshark, I took a look into the SMB objects found:

![Pasted image 20250107084152](https://github.com/user-attachments/assets/64c6185e-7f86-43bd-88ce-e5987fc2859d)

These are the DLL files that were transfered over the network between host 10.0.0.149 and the Domain Controller 10.0.0.6. 

![Pasted image 20250107084256](https://github.com/user-attachments/assets/bae61d2a-dc10-4c22-bab7-29ae33417118)

Once the objercts were exported, I generated the hash for all of them:

![Pasted image 20250107084945](https://github.com/user-attachments/assets/9141f702-d709-4288-9972-ce86d6d2296b)

Of the hashes that were generated, there were 3 identical hashes related to the original hash I investaged originally above.

sha256: 713207d9d9875ec88d2f3a53377bf8c2d620147a4199eb183c13a7e957056432

```
713207d9d9875ec88d2f3a53377bf8c2d620147a4199eb183c13a7e957056432  %5cefweioirfbtk.dll
d301995d31c0b30e157fb8c1f54937ff080e79fe4b2a9c5c8a28621dfc1e8040  %5cefweioirfbtk.dll.cfg
713207d9d9875ec88d2f3a53377bf8c2d620147a4199eb183c13a7e957056432  %5cltoawuimupfxvg.dll
24f40ab61aef3d64868b04d0d512b0c6cd6489d7ae1f1d6c342cff81a897b2ef  %5cltoawuimupfxvg.dll.cfg
713207d9d9875ec88d2f3a53377bf8c2d620147a4199eb183c13a7e957056432  %5cumtqqzkklrgp.dll
663628ae2089e3a5bd333fd9a6c5f390334af6899d9afe64d42547cc833c8469  %5cumtqqzkklrgp.dll.cfg
```
In conclusion, based on the research done and the information gathered, there were 2 compromised hosts on the network (10.0.0149 and 10.0.06). Both were infected with Malware related to Qakbot. 

## Defensive Measures:

+ Both hosts were isolated and disconnected from the network
+ Malware was removed and both hosts were reimaged
+ Ensured that services and protocols that were unused were disabled
+ Ensured that there were no other hosts infected on the network based on the IOCs gathered above
+ Firewall rules were updated to block the IP and URL associated with the malware
+ IDS/IPS rules were updated as well
